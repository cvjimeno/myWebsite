---
// src/pages/trayectoria.astro (FINAL CORRECTED VERSION)
import BaseLayout from "../layouts/BaseLayout.astro";
import AlternatingTimelineItem from "../components/career/AlternatingTimelineItem.astro";
import PublicationCard from "../components/career/PublicationCard.astro";
import Badge from "../components/common/Badge.astro";
import { Image } from "astro:assets";
import Icon from '../components/common/Icon.astro';

// --- DATA: LOGOS ---
import philipsLogo from "../assets/images/logos/philips-logo.webp";
import kclLogo from "../assets/images/logos/kcl-logo.png";
import cnicLogo from "../assets/images/logos/cnic-logo.png";
import ucmLogo from "../assets/images/logos/ucm-logo.webp";

// --- DATA: ILLUSTRATIONS ---
import placeholderIllustration from "../assets/images/illustrations/img1.png";

// --- CAREER PATH DATA ---
const careerPath = [
  { id: "philips", logoSrc: philipsLogo, logoAlt: "Philips Logo", role: "Clinical Scientist", institutionName: "Philips", institutionColor: "#0B5ED7", dates: "Ene 2024 - Actualidad", descriptionLines: ["Proporciono soporte científico y técnico a una red de más de 15 hospitales y centros de investigación de referencia en Iberia, centrándome en la Resonancia Magnética (RM) avanzada.", "Colaboro en proyectos de investigación, ayudo a optimizar protocolos de adquisición y reconstrucción, y actúo como puente entre las necesidades clínicas y las soluciones tecnológicas de Philips."], skills: ["MRI Avanzada", "Soporte Clínico", "Optimización de Protocolos"], illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], },
  { id: "kcl", logoSrc: kclLogo, logoAlt: "King's College London Logo", role: "Investigador Post-Doctoral", institutionName: "King's College London", institutionColor: "#E22221", dates: "Dic 2019 - Dic 2023", descriptionLines: ["Desarrollé nuevas secuencias de RM para aplicaciones cardiovasculares y hepáticas, trabajando en St. Thomas' Hospital.", "Mi trabajo se centró en secuencias de RM multiparamétricas, principalmente MR Fingerprinting."], skills: ["MR Fingerprinting", "C++ (Pulse Programming)", "MATLAB", "Reconstrucción de Imagen (Gadgetron)"], illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], },
  { id: "cnic", logoSrc: cnicLogo, logoAlt: "CNIC Logo", role: "Investigador Pre-Doctoral (PhD)", institutionName: "Centro Nacional de Investigaciones Cardiovasculares (CNIC)", institutionColor: "#D40046", dates: "Sep 2015 - Nov 2019", descriptionLines: ["Mi tesis se centró en el desarrollo de nuevas técnicas de imagen multimodal (PET/CT) en un entorno altamente multidisciplinario.", "Implementé el uso de un nuevo radiotrazador (<sup>68</sup>Ga-DOTA) para estudios de perfusión, desarrollé hardware para análisis de sangre y trabajé en proyectos desde bioquímica hasta análisis de imagen."], skills: ["PET/RM Multimodal", "Python (Análisis de Imagen)", "Diseño de Hardware (CAD)", "Síntesis de Nanopartículas"], illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], },
  { id: "ucm-master", logoSrc: ucmLogo, logoAlt: "Universidad Complutense de Madrid Logo", role: "Máster en Física Biomédica / Grado en Física", institutionName: "Universidad Complutense de Madrid", institutionColor: "#708090", dates: "2008 - 2014", descriptionLines: ["<strong>Máster en Física Biomédica (2013-2014):</strong> Especialización en las bases físicas de las técnicas de imagen médica, radioterapia y instrumentación biomédica. Trabajo de Fin de Máster sobre simulación y análisis de imagen y dosimetría para radioterapia intraoperatoria.", "<strong>Grado en Física (2008-2013):</strong> Formación fundamental en todas las áreas de la física, con especialización en física teórica. Trabajo de Fin de Carrera sobre el bosón de Higgs."], skills: ["Física Teórica", "Análisis Matemático", "Programación Científica", "Mecánica Cuántica", "Física Biomédica", "Simulación de Imagen", "Dosimetría", "Radioterapia"], illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], },
];

// --- PHD THESIS DATA ---
const phdThesis = { title: "Técnicas de Imagen Avanzada Aplicadas a la Investigación Cardiovascular", link: "https://docta.ucm.es/entities/publication/69475632-a3a4-4fb9-817a-c746717682e8", impactStatement: "Mi tesis se centró en el desarrollo de nuevas técnicas de imagen multimodal (PET/CT) en un entorno altamente multidisciplinario. Implementé el uso de un nuevo radiotrazador (68Ga-DOTA) para estudios de perfusión, desarrollé hardware para análisis de sangre y trabajé en proyectos desde bioquímica hasta análisis de imagen." };

// --- PUBLICATIONS DATA ---
const publications = [
  { year: "2023", journal: "Magnetic Resonance in Medicine", title: "Simultaneous T<sub>1</sub>, T<sub>2</sub>, and T<sub>1ρ</sub> cardiac magnetic resonance fingerprinting for contrast agent–free myocardial tissue characterization", authors: "Velasco C, Cruz G, Lavin B, Hua A, Fotaki A, Botnar RM, Prieto C.", link: "https://onlinelibrary.wiley.com/doi/10.1002/mrm.29091", },
  { year: "2022", journal: "Magnetic Resonance in Medicine", title: "Simultaneous comprehensive liver T<sub>1</sub>, T<sub>2</sub>, T<sub>1ρ</sub>, and fat fraction characterization with MR fingerprinting.", authors: "Velasco C, Cruz G, Jaubert O, Lavin B, Botnar RM, Prieto C.", link: "https://doi.org/10.1002/mrm.29089", },
  { year: "2022", journal: "Frontiers in Cardiovascular Medicine", title: "Artificial intelligence in cardiac magnetic resonance fingerprinting", authors: "Velasco C, Fletcher TJ, Botnar RM, Prieto C.", link: "https://www.frontiersin.org/journals/cardiovascular-medicine/articles/10.3389/fcvm.2022.1009131", },
  { year: "2021", journal: "Arteriosclerosis, Thrombosis, and Vascular Biology", title: "Analysis of <sup>18</sup>F-Sodium Fluoride Positron Emission Tomography Signal Sources in Atherosclerotic Minipigs Shows Specific Binding of <sup>18</sup>F-Sodium Fluoride to Plaque Calcifications", authors: "Nogales P, Velasco C, Mota-Cobián A, González-Cintado L, Mota RA, España S, Mateo J, Bentzon JF.", link: "https://doi.org/10.1161/ATVBAHA.121.316075", },
  { year: "2021", journal: "Cancers", title: "Current Applications and Future Development of Magnetic Resonance Fingerprinting in Diagnosis, Characterization, and Response Monitoring in Cancer", authors: "Ding H, Velasco C, Ye H, Lindner T, Grech-Sollars M, O’Callaghan J, Hiley C, Chouhan MD, Niendorf T, Koh DM, Prieto C, Adeleke S.", link: "https://doi.org/10.3390/cancers13194742", },
  { year: "2020", journal: "Journal of Nuclear Cardiology", title: "Quantitative assessment of myocardial blood flow and extracellular volume fraction using <sup>68</sup>Ga-DOTA-PET: A feasibility and validation study in large animals", authors: "Velasco C, Mota-Cobián A, Mota RA, Pellico J, Herranz F, Galán-Arriola C, Ibáñez B, Ruiz-Cabello J, Mateo J, España S.", link: "https://doi.org/10.1007/s12350-019-01694-z", },
  { year: "2020", journal: "EJNMMI Physics", title: "Explicit measurement of multi-tracer arterial input function for PET imaging using blood sampling spectroscopy", authors: "Velasco C, Mota-Cobián A, Mateo J, España S.", link: "https://doi.org/10.1186/s40658-020-0277-4", },
  { year: "2019", journal: "EJNMMI Physics", title: "Development of a blood sample detector for multi-tracer positron emission tomography using gamma spectroscopy", authors: "Velasco C, Mota-Cobián A, Mateo J, España S.", link: "https://doi.org/10.1186/s40658-019-0263-x", },
  { year: "2017", journal: "EJNMMI Research", title: "Assessment of regional pulmonary blood flow using <sup>68</sup>Ga-DOTA PET", authors: "Velasco C, Mateo J, Santos A, Mota-Cobian A, Herranz F, Pellico J, Mota RA, España S, Ruiz-Cabello J.", link: "https://doi.org/10.1186/s13550-017-0259-2", },
];

const pageTitle = "Mi Trayectoria";
const introText = "Un resumen de mi camino profesional y académico, desde la investigación fundamental hasta la aplicación de la ciencia de datos e IA en entornos clínicos e industriales.";
---


<BaseLayout title={pageTitle} description={introText}>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">

    <!-- THE DEFINITIVE HEADER SECTION -->
    <header class="grid grid-cols-1 md:grid-cols-5 gap-x-12 gap-y-10 items-center mb-16 md:mb-24">
      
      <!-- Left Column: Title & Intro (spans 3 of 5 columns) -->
      <div class="md:col-span-3 text-center md:text-left">
        <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-text-primary mb-6 leading-tight">
          {pageTitle}
        </h1>
        <p class="text-lg sm:text-xl text-text-secondary leading-relaxed max-w-xl">
          {introText}
        </p>
      </div>
      
      <!-- Right Column: Animated Stats (spans 2 of 5 columns) -->
      <div class="md:col-span-2 flex items-center justify-center md:justify-start">
        <ul class="space-y-6">
            <li class="stat-item flex items-center gap-x-5 opacity-0">
                <span data-goal="15" class="stat-number text-5xl md:text-6xl font-bold text-accent-primary min-w-[80px] text-right">0</span>
                <p class="stat-label text-base text-text-secondary">Años de experiencia</p>
            </li>
            <li class="stat-item flex items-center gap-x-5 opacity-0" style="animation-delay: 150ms;">
                <span data-goal="3" class="stat-number text-5xl md:text-6xl font-bold text-accent-primary min-w-[80px] text-right">0</span>
                <p class="stat-label text-base text-text-secondary">Disciplinas conectadas</p>
            </li>
            <li class="stat-item flex items-center gap-x-5 opacity-0" style="animation-delay: 300ms;">
                <span data-goal="9" class="stat-number text-5xl md:text-6xl font-bold text-accent-primary min-w-[80px] text-right">0</span>
                <p class="stat-label text-base text-text-secondary">Publicaciones científicas</p>
            </li>
        </ul>
      </div>
    </header>
    <!-- END FINAL HEADER SECTION -->

    <section id="timeline" class="mb-16 ">
      <h2 class="text-3xl md:text-4xl font-semibold text-text-primary mb-4 text-center leading-tight">
        Viaje Profesional
      </h2>
      <div class="relative max-w-5xl mx-auto">
        <div class="absolute top-10 bottom-10 left-10 md:left-1/2 -translate-x-1/2 w-0.5 bg-border-subtle/40 -z-20" aria-hidden="true"></div>
        <div id="timeline-fuse" class="absolute top-10 left-10 md:left-1/2 -translate-x-1/2 w-0.5 bg-accent-primary z-0" style="height: 0;"></div> 
        <ol class="max-w-5xl mx-auto space-y-8 md:space-y-4">
          {careerPath.map((item, index) => (
              <AlternatingTimelineItem
                {...item}
                illustrations={item.illustrations}
                textOnRight={index % 2 !== 0}
                isLastItem={index === careerPath.length - 1}
              />
            ))}
        </ol>
      </div>
    </section>

    <section id="publications" class="bg-bg-secondary dark:bg-bg-secondary border-y border-border-subtle -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-16 md:py-24">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-semibold text-text-primary mb-12 text-center leading-tight">
          Publicaciones Destacadas
        </h2>
        <div class="max-w-3xl mx-auto p-4 sm:p-6 bg-bg-card rounded-lg shadow-sm border-l-4 border-accent-primary mb-10 md:mb-12">
          <h3 class="text-base sm:text-lg font-semibold text-text-primary mb-2">Mi Tesis Doctoral</h3>
          <p class="text-sm sm:text-base text-text-secondary mb-3 leading-relaxed">{phdThesis.impactStatement}</p>
          <a href={phdThesis.link} target="_blank" rel="noopener noreferrer" class="text-sm sm:text-base text-accent-primary font-medium hover:underline">Ver Tesis Completa →</a>
        </div>
        <div id="publication-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
          {publications.map((pub) => (
            <div class="publication-item" data-year={pub.year}>
              <PublicationCard {...pub} />
            </div>
          ))}
        </div>
        <div class="mt-12 md:mt-16 text-center md:text-right">
          <h3 class="text-base sm:text-lg font-semibold text-text-primary mb-4">Conecta sobre investigación</h3>
          <div class="flex flex-wrap justify-center md:justify-end items-center gap-x-6 gap-y-3">
            <a href="https://scholar.google.com/citations?user=0gpttXAAAAAJ&hl=es" target="_blank" rel="noopener noreferrer" aria-label="Google Scholar" class="text-text-secondary hover:text-accent-primary transition-colors">
              <Icon name="google-scholar" size="w-6 h-6" />
            </a>
            <a href="https://www.researchgate.net/profile/Carlos-Velasco-Jimeno" target="_blank" rel="noopener noreferrer" aria-label="ResearchGate" class="text-text-secondary hover:text-accent-primary transition-colors">
              <Icon name="ResearchGate" size="w-6 h-6" />
            </a>
            <a href="https://linkedin.com/in/carlos-velasco-jimeno/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn" class="text-text-secondary hover:text-accent-primary transition-colors">
              <Icon name="linkedin" size="w-6 h-6" />
            </a>
          </div>
        </div>
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  @keyframes slide-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .stat-item.is-visible {
    animation: slide-in-up 0.6s ease-out forwards;
  }
</style>

<script>
  // This script remains the same as the previous version, as it correctly targets the elements.
  function setupPageAnimations() {
    // --- PART 1: STATS ANIMATION ---
    const statItems = document.querySelectorAll('.stat-item');
    if (statItems.length > 0) {
      const animateCountUp = (el) => {
        const goal = parseInt(el.dataset.goal, 10);
        let startTime = null;
        const step = (timestamp) => {
          if (!startTime) startTime = timestamp;
          const progress = Math.min((timestamp - startTime) / 2000, 1);
          const easeOutProgress = 1 - Math.pow(1 - progress, 3);
          el.textContent = Math.floor(easeOutProgress * goal);
          if (progress < 1) {
            window.requestAnimationFrame(step);
          } else {
            el.textContent = `${goal}+`;
          }
        };
        window.requestAnimationFrame(step);
      };

      const statsObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            const numberEl = entry.target.querySelector('.stat-number');
            if (numberEl) animateCountUp(numberEl);
            statsObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.5 });

      statItems.forEach(item => statsObserver.observe(item));
    }

    // --- PART 2: TIMELINE ANIMATION ---
    const timelineItems = Array.from(document.querySelectorAll(".timeline-item"));
    const fuse = document.getElementById("timeline-fuse");

    if (!timelineItems.length || !fuse) return;

    const handleScroll = () => {
      const firstItem = timelineItems[0];
      const lastItem = timelineItems[timelineItems.length - 1];
      if (!firstItem || !lastItem) return;

      const startY = firstItem.offsetTop;
      const endY = lastItem.offsetTop + lastItem.offsetHeight;
      const totalHeight = endY - startY;
      let scrollProgress = window.scrollY - startY;
      let progressPercentage = (scrollProgress / totalHeight) * 100;

      const fuseBottom = fuse.getBoundingClientRect().top + fuse.offsetHeight + window.scrollY;
      let closestActiveId = null;
      let minDelta = Infinity;

      for (const item of timelineItems) {
        const logoNode = item.querySelector(".logo-node");
        if (logoNode) {
          const logoCenter = logoNode.getBoundingClientRect().top + logoNode.clientHeight / 2 + window.scrollY;
          const delta = fuseBottom - logoCenter;
          if (delta >= -10 && delta < minDelta) {
            minDelta = delta;
            closestActiveId = item.id;
          }
          logoNode.style.setProperty("--circle-progress", (item.id === closestActiveId && delta >= -10) ? "1" : "0");
        }
        const itemRect = item.getBoundingClientRect();
        const illustrationTriggerPoint = itemRect.top + window.scrollY + itemRect.height * 0.5;
        item.classList.toggle("is-illustrations-active", fuseBottom >= illustrationTriggerPoint);
      }

      for (const item of timelineItems) {
        item.classList.toggle("is-active", item.id === closestActiveId);
      }

      if (!closestActiveId) {
        fuse.style.height = `${Math.max(0, Math.min(100, progressPercentage))}%`;
      } else {
        const activeLogoNode = document.getElementById(closestActiveId)?.querySelector(".logo-node");
        if (activeLogoNode) {
          const circleProgress = parseFloat(getComputedStyle(activeLogoNode).getPropertyValue("--circle-progress") || "0");
          if (circleProgress >= 0.98) {
            fuse.style.height = `${Math.max(0, Math.min(100, progressPercentage))}%`;
          } else {
            const prevItemIndex = timelineItems.findIndex(el => el.id === closestActiveId) - 1;
            if (prevItemIndex >= 0) {
              const prevItem = timelineItems[prevItemIndex];
              const prevItemBottom = prevItem.offsetTop + prevItem.offsetHeight - startY;
              progressPercentage = (prevItemBottom / totalHeight) * 100;
              fuse.style.height = `${Math.max(0, Math.min(100, progressPercentage))}%`;
            } else {
              fuse.style.height = "0%";
            }
          }
        }
      }
    };

    document.addEventListener("scroll", handleScroll, { passive: true });
    
    document.addEventListener("astro:before-swap", () => {
      document.removeEventListener("scroll", handleScroll);
    }, { once: true });
    
    handleScroll();
  }

  document.addEventListener("astro:page-load", setupPageAnimations);
  setupPageAnimations();
</script>