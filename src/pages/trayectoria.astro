---
// src/pages/trayectoria.astro (FINAL ANIMATED VERSION)
import BaseLayout from '../layouts/BaseLayout.astro';
import AlternatingTimelineItem from '../components/career/AlternatingTimelineItem.astro';
import Badge from '../components/common/Badge.astro';

// --- DATA: LOGOS ---
import philipsLogo from '../assets/images/logos/philips-logo.svg';
import kclLogo from '../assets/images/logos/kcl-logo.png';
import cnicLogo from '../assets/images/logos/cnic-logo.png';
import ucmLogo from '../assets/images/logos/ucm-logo.svg';

// --- DATA: ILLUSTRATIONS (We will use a single placeholder for now) ---
import placeholderIllustration from '../assets/images/illustrations/img1.png';

// --- CAREER PATH: Now 5 items, with an 'illustrations' array ---
const careerPath = [
  {
    id: 'philips',
    logoSrc: philipsLogo,
    logoAlt: 'Philips Logo',
    role: 'Clinical Scientist',
    institutionName: 'Philips',
    institutionColorClass: 'text-accent-primary',
    dates: 'Ene 2025 - Actualidad',
    descriptionLines: ['Proporciono soporte científico y técnico a una red de más de 15 hospitales y centros de investigación de referencia en Iberia, centrándome en la Resonancia Magnética (RM) avanzada.', 'Colaboro en proyectos de investigación, ayudo a optimizar protocolos de adquisición y reconstrucción, y actúo como puente entre las necesidades clínicas y las soluciones tecnológicas de Philips.'],
    skills: ['MRI Avanzada', 'Soporte Clínico', 'Optimización de Protocolos'],
    illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], // 3 placeholders
  },
  {
    id: 'kcl',
    logoSrc: kclLogo,
    logoAlt: "King's College London Logo",
    role: 'Investigador Post-Doctoral',
    institutionName: "King's College London",
    institutionColorClass: 'text-red-600',
    dates: 'Dic 2019 - Dic 2024',
    descriptionLines: ['Desarrollé nuevas secuencias de RM para aplicaciones cardiovasculares y hepáticas, trabajando en St. Thomas\' Hospital.', 'Mi trabajo se centró en secuencias de RM multiparamétricas, principalmente MR Fingerprinting.'],
    skills: ['MR Fingerprinting', 'C++ (Pulse Programming)', 'MATLAB', 'Reconstrucción de Imagen (Gadgetron)'],
    illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], // 3 placeholders
  },
  {
    id: 'cnic',
    logoSrc: cnicLogo,
    logoAlt: 'CNIC Logo',
    role: 'Investigador Pre-Doctoral (PhD)',
    institutionName: 'Centro Nacional de Investigaciones Cardiovasculares (CNIC)',
    institutionColorClass: 'text-red-800',
    dates: 'Sep 2015 - Nov 2019',
    descriptionLines: ['Mi tesis se centró en el desarrollo de nuevas técnicas de imagen multimodal (PET/RM) en un entorno altamente multidisciplinario.', 'Implementé el uso de un nuevo radiotrazador (<sup>68</sup>Ga-DOTA) para estudios de perfusión, desarrollé hardware para análisis de sangre y trabajé en proyectos desde bioquímica hasta análisis de imagen.'],
    skills: ['PET/RM Multimodal', 'Python (Análisis de Imagen)', 'Diseño de Hardware (CAD)', 'Síntesis de Nanopartículas'],
    illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], // 3 placeholders
  },
  {
    id: 'ucm-master',
    logoSrc: ucmLogo,
    logoAlt: 'Universidad Complutense de Madrid Logo',
    role: 'Máster en Física Biomédica',
    institutionName: 'Universidad Complutense de Madrid',
    institutionColorClass: 'text-fuchsia-700',
    dates: '2013 - 2014',
    descriptionLines: ['Especialización en las bases físicas de las técnicas de imagen médica, radioterapia y instrumentación biomédica.', 'Trabajo de Fin de Máster sobre simulación y análisis de imagen y dosimetría para radioterapia intraoperatoria.'],
    skills: ['Física Biomédica', 'Simulación de Imagen', 'Dosimetría', 'Radioterapia'],
    illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], // 3 placeholders
  },
  {
    id: 'ucm-grado',
    logoSrc: ucmLogo,
    logoAlt: 'Universidad Complutense de Madrid Logo',
    role: 'Grado en Física',
    institutionName: 'Universidad Complutense de Madrid',
    institutionColorClass: 'text-fuchsia-700',
    dates: '2008 - 2013',
    descriptionLines: ['Formación fundamental en todas las áreas de la física, con especialización en física teórica.', 'Trabajo de Fin de Carrera sobre el bosón de Higgs.'],
    skills: ['Física Teórica', 'Análisis Matemático', 'Programación Científica', 'Mecánica Cuántica'],
    illustrations: [placeholderIllustration, placeholderIllustration, placeholderIllustration], // 3 placeholders
  },
];

// ... (rest of the file remains the same: phdThesis, publications, layout, etc.) ...
const phdThesis = {
  title: "Técnicas de Imagen Avanzada Aplicadas a la Investigación Cardiovascular",
  link: "https://docta.ucm.es/entities/publication/69475632-a3a4-4fb9-817a-c746717682e8"
};

const publications = [
  { year: '2023', journal: 'Magnetic Resonance in Medicine', title: 'Simultaneous T1, T2, and T1ρ cardiac magnetic resonance fingerprinting for contrast agent–free myocardial tissue characterization', authors: 'Velasco C, Cruz G, Lavin B, et al.', link: 'https://onlinelibrary.wiley.com/doi/10.1002/mrm.29091', tags: ['MR Fingerprinting', 'Cardiovascular', 'T1ρ'], isFeatured: true, award: 'ISMRM Gold Mention', },
  { year: '2022', journal: 'Magnetic Resonance in Medicine', title: 'Simultaneous comprehensive liver T1, T2,T2* T1ρ, and fat fraction characterization with MR fingerprinting.', authors: 'Velasco C, Cruz G, Jaubert O, Lavin B, Botnar RM, Prieto C.', link: 'https://onlinelibrary.wiley.com/doi/full/10.1002/mrm.29089', tags: ['MR Fingerprinting', 'Liver', 'T1ρ'], award: 'ISMRM Silver Mention', },
  { year: '2019', journal: 'Scientific Reports', title: 'Atherosclerosis imaging with a new 68Ga-labeled D-mannose derivative for PET/CT and its evaluation in an animal model', authors: 'Velasco C, et al.', link: 'https://www.nature.com/articles/s41598-019-54845-0', tags: ['PET', 'Nanopartículas', 'Aterosclerosis'], isReview: true },
];

const pageTitle = "Mi Trayectoria";
const introText = "Un resumen de mi camino profesional y académico, desde la investigación fundamental hasta la aplicación de la ciencia de datos e IA en entornos clínicos e industriales.";
---

<BaseLayout title={pageTitle} description={introText}>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">
    <header class="max-w-3xl mx-auto text-center mb-16 md:mb-20">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-text-primary mb-6">{pageTitle}</h1>
      <p class="text-xl text-text-secondary leading-relaxed">{introText}</p>
    </header>

    <section id="timeline" class="mb-16 md:mb-24">
      <h2 class="text-3xl md:text-4xl font-semibold text-text-primary mb-16 text-center">Viaje Profesional</h2>
      <div class="relative">
        <div id="timeline-fuse" class="absolute top-0 left-10 md:left-1/2 -translate-x-1/2 h-full w-0.5 bg-accent-primary z-0" style="height: 0;"></div>
        <ol class="max-w-5xl mx-auto space-y-8 md:space-y-4">
          {careerPath.map((item, index) => (
            <AlternatingTimelineItem
              {...item}
              textOnRight={index % 2 !== 0}
              isLastItem={index === careerPath.length - 1}
            />
          ))}
        </ol>
      </div>
    </section>

    <section id="publications" class="mb-16 md:mb-24">
      <h2 class="text-3xl md:text-4xl font-semibold text-text-primary mb-12 text-center">Publicaciones Destacadas</h2>
      <div class="max-w-4xl mx-auto space-y-10">
        <!-- Thesis Highlight -->
        <div class="p-6 bg-bg-secondary dark:bg-bg-secondary rounded-lg border-l-4 border-accent-primary">
          <h3 class="font-semibold text-text-primary mb-2">Mi Tesis Doctoral</h3>
          <p class="text-text-secondary mb-3">{phdThesis.title}</p>
          <a href={phdThesis.link} target="_blank" rel="noopener noreferrer" class="text-accent-primary font-medium hover:underline">Leer la tesis completa →</a>
        </div>
        
        <!-- List of Publications -->
        {publications.map(pub => (
          <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 py-4 border-b border-border-card last:border-b-0">
            <div class="md:col-span-1 text-sm text-text-secondary mb-2 md:mb-0">
              <p class="font-semibold">{pub.year}</p>
              <p>{pub.journal}</p>
            </div>
            <div class="md:col-span-3">
              <div class="flex items-center flex-wrap gap-x-3 gap-y-2 mb-2">
                <h4 class="text-lg font-semibold text-text-primary">
                  <a href={pub.link} target="_blank" rel="noopener noreferrer" class="hover:text-accent-primary transition-colors">{pub.title}</a>
                </h4>
                {pub.isFeatured && <span class="text-amber-400" title="Destacado">⭐</span>}
              </div>
              <div class="flex items-center flex-wrap gap-x-2 gap-y-2 mb-3">
                {pub.isReview && <Badge variant="neutral" text="Review" />}
                {pub.award && pub.award.toLowerCase().includes('gold') && <Badge variant="award" awardType="gold" text={pub.award} />}
                {pub.award && pub.award.toLowerCase().includes('silver') && <Badge variant="award" awardType="silver" text={pub.award} />}
              </div>
              <p class="text-sm text-text-secondary mb-3">{pub.authors}</p>
              <div class="flex flex-wrap gap-2">
                {pub.tags.map(tag => <Badge variant="neutral" text={tag} />)}
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Connect Section -->
    <section id="connect" class="text-center">
      <h2 class="text-3xl md:text-4xl font-semibold text-text-primary mb-6">Conecta Conmigo</h2>
      <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-3">
        <a href="https://scholar.google.com/citations?user=0gpttXAAAAAJ&hl=es" target="_blank" rel="noopener noreferrer" class="text-lg text-accent-primary hover:underline underline-offset-4">Google Scholar</a>
        <a href="https://linkedin.com/in/cvjimeno/" target="_blank" rel="noopener noreferrer" class="text-lg text-accent-primary hover:underline underline-offset-4">LinkedIn</a>
        <a href="/contacto" class="text-lg text-accent-primary hover:underline underline-offset-4">Contacto Directo</a>
      </div>
    </section>

  </div>
</BaseLayout>
<script>
  function setupTimelineAnimations() {
    const timelineItems = Array.from(document.querySelectorAll('.timeline-item'));
    const fuse = document.getElementById('timeline-fuse');

    if (!timelineItems.length || !fuse) return;

    const handleScroll = () => {
      // --- Fuse line animation ---
      const firstItem = timelineItems[0];
      const lastItem = timelineItems[timelineItems.length - 1];
      const startY = firstItem.offsetTop;
      const endY = lastItem.offsetTop + lastItem.offsetHeight;
      const totalHeight = endY - startY;
      const scrollProgress = window.scrollY - startY;
      let progressPercentage = (scrollProgress / totalHeight) * 100;
      fuse.style.height = `${Math.max(0, Math.min(100, progressPercentage))}%`;

      // --- Combined active state logic ---
      const fuseBottom = fuse.getBoundingClientRect().top + fuse.offsetHeight + window.scrollY;
      let closestActiveId = null;
      let minDelta = Infinity;

      for (const item of timelineItems) {
        // --- Logic for Logo Scaling ---
        const logoDot = item.querySelector('.logo-dot');
        if (logoDot) {
          const logoCenter = logoDot.getBoundingClientRect().top + (logoDot.clientHeight / 2) + window.scrollY;
          const delta = fuseBottom - logoCenter;
          if (delta >= -10 && delta < minDelta) { // Added a small -10px tolerance for feel
            minDelta = delta;
            closestActiveId = item.id;
          }
        }
        
        // --- Logic for Illustration Grayscale ---
        const itemRect = item.getBoundingClientRect();
        const illustrationTriggerPoint = itemRect.top + window.scrollY + (itemRect.height * 0.50); // Activate when fuse passes 35% of the item
        item.classList.toggle('is-illustrations-active', fuseBottom >= illustrationTriggerPoint);
      }

      // --- Apply active class for logo scaling ---
      for (const item of timelineItems) {
        item.classList.toggle('is-active', item.id === closestActiveId);
      }
    };

    document.addEventListener('scroll', handleScroll, { passive: true });
    document.addEventListener('astro:before-swap', () => {
      document.removeEventListener('scroll', handleScroll);
    }, { once: true });
    handleScroll();
  }

  document.addEventListener('astro:page-load', setupTimelineAnimations);
</script>